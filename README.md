# Robot Control Stack

## C++ build
### Dependencies
To install the dependencies use the following command for debian based systems:
```shell
sudo apt install build-essential cmake git libpoco-dev libeigen3-dev libxslt-dev libcoin-dev libccd-dev libglfw3-dev clang libboost-all-dev liblzma-dev ninja-build clang-format clang clang-tidy python3-venv
```
For arch based systems:
`libpoco` is `poco` and `libeigen` is `eigen` in pacman.

In order to use the `wrlview` program from the `rl` library, you have to install QT. On debian-based system use:
```shell
sudo apt-get install qt5-qmake qtbase5-dev libsoqt520-dev
```

### Compile
```shell
make gcccompile
```
If you build with GCC >= 12 you will get a false positive array-bounds error.
Cf. [here](https://github.com/google-deepmind/mujoco/issues/1489) for solutions.
Otherwise, just use clang instead.
```shell
make clangcompile
```

### Formatting and Linting
```shell
# check for formatting errors
make cppcheckformat
# fix them
make cppformat
# Linting with clang tidy
make cpplint
```

## Python Package
The python package is called `rcsss` (sss because of the sound of a snake).
The following part shows to install the python package which include bindings for the C++ code.

```shell
# create new virtual env and activate it
virtualenv --python=python3.11 venv
source venv/bin/activate
```
Export CC and CXX env vars, to use clang (cf. above why you might want to):
```shell
export CC=/usr/bin/clang
export CXX=/usr/bin/clang++
```
then install the pip package:
```shell
pip install -e .
```

Import the library in python:
```python
import rcsss
```

The package includes a command line interface which define useful commands to handle the hardware robot.
To list all available subcommands use:
```shell
python -m rcsss --help
```

### Formatting, Linting and Testing
```shell
# before you need to install the linter and formatter dependencies:
pip install -r requirements_dev.txt
# check for formatting errors
make pycheckformat
# fix them
make pyformat
# Linting with ruff and mypy
make pylint
# Testing
make pytest
```


### Stub Files for Python Bindings
We use autogenerated python stub files (`.pyi`) in the [`_core`](python/rcsss/_core/) folder to show our linters the expected types of the C++ Python bindings.
If the python bindings in the C++ code have changed you might need to regenerate them by using:
```shell
make stubgen
```

## Hardware
### Microsoft Azure Kinect
Use the following install script to install k4a on debian-based systems:
```shell
# source your virtual env before
source venv/bin/activate
# install the python lib
./install_kinect_4ak.sh
```
or download the wheel package from the github pipeline artifacts and install it with
```shell
# source your virtual env before
source venv/bin/activate
# install wheel
python -m pip install <name>.whl
```

In order to avoid putting `libdepthengine.so.2.0` into `/usr/lib/x86_64-linux-gnu` (see [this issue](https://github.com/microsoft/Azure-Kinect-Sensor-SDK/issues/1707)) export `LD_LIBRARY_PATH`:
```shell
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:venv/lib/python3.xy/site-packages/k4a/_libs
```

## Config
A sample config can be generated via the following CLI command.
```shell
python -m rcsss sample-config
```
The command will produce a `config.yaml` file with sample values.
See [config.py](python/rcsss/config.py) for a description of the config fields.
